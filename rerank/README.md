# T5-based Sparse Vector Representation for Text Document Ranking

## Define the Weights Mathematically

In this implementation, the weights for each document and query for expanded tokens and original tokens are defined as follows:

### Document Weights:

1. Generate Token Scores:

- The model generates a sequence of scores over the vocabulary using the `generate_token_scores` function.
- These scores represent the relevance of each token in the vocabulary for a given document.
- For each token in the vocabulary, the maximum score is found and stored in `max_scores_map`.

2. Select Top Tokens:

- The `get_top_token_ids` function selects the top k token IDs based on their scores from the max_scores_map.
- The `get_top_tokens` function selects the top k tokens along with their scores from the max_scores_map.

3. Document Weights in `doc_rep_is_topk_token.py`:

- The document weights are the top k token IDs and their corresponding scores from the `max_scores_map`.

4. Document Weights in `modify_doc_rep_xxx.py`:

- The document weights are a combination of the top k token IDs and scores from `doc_rep_is_topk_token.py` and the original tokens' corresponding IDs and weights in the document.

### Query Weights:

1. Query Weights in `doc_rep_is_topk_token.py`:

- Initially, the query weights comprise the token IDs and their scores from the `max_scores_map` similar to how document weights are derived. This set forms the initial representation of the query in terms of the most relevant tokens according to the model.

- This method simplifies the system by maintaining a single scoring mechanism for both documents and queries. Thus, in the initial stage to process query, the query representation is not retrieved. Instead, during the score calculation stage, use query ids to match with document ids, for the common ones, search them in the `max_scores_map` to get their weights.

2. Query Weights in `modify_query_rep_xxx.py`:

- Expand the query by using the query text to generate top 50 tokens, and append with the original query text.
- For the generated 50 tokens, their IDs and weights can be retrieved by calling `get_top_tokens` function.
- Similarly, the initial query weights do not need to retrieve.

### Combined Score Calculation:

For each query-document pair, the score is calculated by summing the squares of the weights of the common tokens between the document and the query.

## Main Modifications from `source_code_splade.py` to `doc_rep_is_topk_token.py`

### Model and Tokenization

Original SPLADE Code:

- Uses `AutoModelForMaskedLM` from Hugging Face Transformers for masked language modeling (MLM).
- Generates token scores for the entire vocabulary in parallel.
- Aggregates scores using either sum or max operations.

Modified T5 Code:

- Replaced SPLADE model with `T5ForConditionalGeneration`/`T5EncoderModel` for generating token scores.
- Implements both autoregressive and non-autoregressive token score generation.

### Token Score Generation

SPLADE:

- Generates token representations using masked language modeling.
- Aggregates scores for each token independently.
- Outputs token scores directly from MLM logits.

T5:

- Generates token scores using T5 model with conditional/unconditional generation.
- For autoregressive generation, processes the entire sequence and normalizes logits using softmax.
- For non-autoregressive generation, iterates over a fixed length, generating and normalizing scores for each step.

### Selection of Top Tokens

SPLADE:

- Processes logits to select top tokens based on their scores.
- Uses an efficient batching mechanism to handle large inputs.

T5:

- Implements functions to select top token IDs and top tokens based on maximum scores.
- Utilizes softmax normalization and top-k selection during token generation.

### Query and Document Weight Integration

SPLADE:

- Directly processes document and query representations generated by MLM.
- Calculates scores by comparing weights of tokens in the query and document.

T5:

- Combines document weights from top tokens and original tokens in the document.
- Generates query token scores, including expanded tokens, and calculates scores by summing squared weights of common tokens between query and document.

### Main Logical Modifications:

Model Initialization:

- Replaced SPLADE model initialization with T5 model initialization.

Token Score Generation:

- Implemented `generate_token_scores` and `generate_token_scores_non_autoregresive` to handle both autoregressive and non-autoregressive generation with T5.

Token Selection:

- Added functions to retrieve top token IDs and top tokens based on scores generated by T5.

Weight Calculation:

- Modified the scoring mechanism to integrate both expanded and original tokens from the T5 model for query-document pairs.

### Summary
The modifications from `source_code_splade.py` to `doc_rep_is_topk_token.py` involved transitioning from a SPLADE-based approach to a T5-based approach. Key changes include updating the model and tokenization methods, implementing new token score generation functions for T5, selecting top tokens based on these scores, and integrating document and query weights using these scores. These changes allow for a more flexible and powerful representation of documents and queries, leveraging the capabilities of the T5 model.